<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Game Of Life</title>
    <link rel="stylesheet" type="text/css" href="./css/index.css">
</head>
<body>
<div id="m_div">
    <canvas id="mycanvas" style="border: 1px solid; solid-color: #000000;">
    </canvas>
    <div>
        <button style="width: 200px; height: 100px;" id="btn">
            开始
        </button>

        <div class="scale" id="bar">
            <div></div>
            <span id="speed"></span>
        </div>
        <div style="margin-left: 20px" id="speed_text">
            速率：<span id="title">0</span>毫秒
        </div>
    </div>
</div>
<script>
    window.live_table = [100];
    var canvas_listen;
    var flag = true;
    document.getElementById("btn").addEventListener("click", start);
    
    function init_table() {
        for (i = 0; i < 100; i++) {
            window.live_table[i] = [190];
            for (j = 0; j<190; j++) {
                window.live_table[i][j] = 0;
            }
        }
        var c = document.getElementById("mycanvas");
        c.width = 900;
        c.height = 900;
        canvas_listen = function (ev) {
            getMousePos(c, ev);
        };
        c.addEventListener("click", canvas_listen);
        var ctx = c.getContext("2d");
        ctx.fillStyle="#ffffff";
        ctx.strokeStyle='#000000';
        ctx.lineWidth = 1;
        for (i=0; i< c.width; i++) {
            for (j = 0; j<c.height; j++) {
                ctx.strokeRect(i*30, j*30, 30, 30);
            }
        }
    }

    function getMousePos(canvas, event) {
        var rect = canvas.getBoundingClientRect();
        var x = Math.floor((event.clientX - rect.left) / 30);
        var y = Math.floor((event.clientY - rect.top) / 30);
        var ctx = canvas.getContext("2d");
        if(window.live_table[x][y] === 1) {
            ctx.fillStyle="#ffffff";
            ctx.strokeStyle='#000000';
            ctx.lineWidth = 1;
            ctx.clearRect(x*30, y*30, 30, 30);
            ctx.strokeRect(x*30, y*30, 30, 30);
            window.live_table[x][y] = 0;
        } else {
            ctx.fillStyle="#000000";
            ctx.fillRect(x*30, y*30, 30, 30);
            window.live_table[x][y] = 1;
        }
    }

    function sleep(ms){
        return new Promise((resolve)=>setTimeout(resolve,ms));
    }

    function end() {
        var btn = document.getElementById("btn");
        btn.innerHTML = '开始';
        flag = false;
        btn.removeEventListener("click", end, false);
        btn.addEventListener("click", start_again);
    }

    function start_again() {
        var btn = document.getElementById("btn");
        btn.innerHTML = '结束';
        flag = true;
        btn.removeEventListener("click", start_again, false);
        btn.addEventListener("click", end);
    }

    async function start() {
        document.getElementById("speed_text").style.color = '#ffffff';
        flag = true;
        var c = document.getElementById("mycanvas");
        c.removeEventListener("click", canvas_listen, false);
        var btn = document.getElementById('btn');
        btn.innerHTML = '结束';
        btn.removeEventListener("click", start, false);
        btn.addEventListener("click", function () {
           flag = false;
           btn.innerHTML = '开始';
           btn.addEventListener("click", start_again);
        });
        while (true) {
            if (flag) {
                flush();
            }
            await sleep(window.speed);
        }
    }

    function flush(){
        var c = document.getElementById("mycanvas");
        c.width = 1850;
        c.height = 1000;
        var ctx = c.getContext("2d");
        document.body.style.background = "#000000";
        ctx.fillStyle="#fff64b";
        ctx.lineWidth = 1;
        for (i=0; i< c.height/10; i++) {
            for (j = 0; j<c.width/10; j++) {
                if (live_table[i][j] === 1) {
                    ctx.fillRect(i*10, j*10, 10, 10);
                }
            }
        }
        cal_table();
    }

    function deep_copy(arr) {
        var temp_table = [arr.length];
        for(i = 0; i < arr.length; i ++) {
            var l = arr[i];
            temp_table[i] = [l];
        }
        return temp_table;
    }

    function cal_table() {
        var temp_table = deep_copy(live_table);
        var c = document.getElementById("mycanvas");
        right = c.width/10;
        bottom = c.height/10;
        // var lowest = 2;
        // var highest = 3;
        for (i = 0; i < bottom; i ++) {
            for (j = 0; j < right; j ++) {
                var count = 0;
                if (i === 0 && j !== 0 && j !== right - 1) {
                    //todo 上边界
                    count = live_table[i][j-1] + live_table[i+1][j-1] + live_table[i+1][j] + live_table[i+1][j+1] + live_table[i][j+1];
                }else if (i === bottom - 1 && j !== 0 && j !== right - 1) {
                    //todo 下边界
                    count = live_table[i][j-1] + live_table[i-1][j-1] + live_table[i-1][j] + live_table[i-1][j+1] + live_table[i][j+1];
                }else if (j === 0 && i !== 0 && i !== bottom - 1) {
                    //todo 左边界
                    count = live_table[i-1][j] + live_table[i-1][j+1] + live_table[i][j+1] + live_table[i+1][j+1] + live_table[i+1][j];
                }else if (j === right - 1 && i !== 0 && i !== bottom - 1) {
                    //todo 右边界
                    count = live_table[i-1][j] + live_table[i-1][j-1] + live_table[i][j-1] + live_table[i+1][j-1] + live_table[i+1][j];
                }else if (i === 0 && j === 0) {
                    //todo 左上角
                    count = live_table[i+1][j] + live_table[i+1][j+1] + live_table[i][j+1];
                }else if (i === 0 && j === right - 1) {
                    //todo 右上角
                    count = live_table[i][j-1] + live_table[i+1][j-1] + live_table[i+1][j];
                }else if (i === bottom - 1 && j === 0) {
                    //todo 左下角
                    count = live_table[i-1][j] + live_table[i-1][j+1] + live_table[i][j+1]
                }else if (i === bottom -1 && j === right - 1) {
                    //todo 右下角
                    count = live_table[i][j-1] + live_table[i-1][j-1] + live_table[i-1][j];
                }else {
                    //todo 中间
                    count = live_table[i-1][j-1] + live_table[i-1][j] + live_table[i-1][j+1] + live_table[i][j-1] + live_table[i][j+1] + live_table[i+1][j-1] + live_table[i+1][j] + live_table[i+1][j+1];
                }
                if (live_table[i][j] === 1 && (count === 2 || count === 3)) {
                    temp_table[i][j] = 1;
                } else if (live_table[i][j] === 0 && count === 3){
                    temp_table[i][j] = 1;
                } else {
                    temp_table[i][j] = 0;
                }
            }
        }
        live_table = temp_table;
    }

    init_table()
</script>
<script src="./js/index.js"></script>
</body>
</html>
